{
  "name": "database-workflow",
  "description": "Database management and migration workflow",
  "version": "1.0.0",
  "triggers": [
    {
      "type": "manual",
      "command": "npx claude-flow workflow execute database"
    },
    {
      "type": "pr",
      "paths": ["src/db/**", "drizzle.config.ts"]
    }
  ],
  "phases": [
    {
      "name": "backup",
      "parallel": false,
      "steps": [
        {
          "id": "backup-production",
          "agent": "devops",
          "command": "npx claude-flow backup create --components database",
          "description": "Backup production database",
          "timeout": 300
        }
      ]
    },
    {
      "name": "migration-prep",
      "parallel": true,
      "steps": [
        {
          "id": "generate-migrations",
          "agent": "developer",
          "command": "pnpm db:generate",
          "description": "Generate database migrations",
          "timeout": 120
        },
        {
          "id": "validate-schema",
          "agent": "tester",
          "command": "npx claude-flow sparc run tdd 'validate database schema' --non-interactive",
          "description": "Validate schema changes",
          "timeout": 180
        }
      ]
    },
    {
      "name": "test-migration",
      "parallel": false,
      "steps": [
        {
          "id": "migrate-local",
          "agent": "developer",
          "command": "pnpm db:migrate:local",
          "description": "Test migration locally",
          "dependencies": ["generate-migrations"],
          "timeout": 180
        },
        {
          "id": "test-local",
          "agent": "tester",
          "command": "pnpm test:db",
          "description": "Run database tests",
          "dependencies": ["migrate-local"],
          "timeout": 300
        }
      ]
    },
    {
      "name": "deploy-preview",
      "parallel": false,
      "steps": [
        {
          "id": "migrate-preview",
          "agent": "devops",
          "command": "pnpm db:migrate:preview",
          "description": "Deploy to preview database",
          "dependencies": ["test-local"],
          "timeout": 300
        },
        {
          "id": "smoke-test-preview",
          "agent": "tester",
          "command": "npx claude-flow sparc run post-deployment-monitoring-mode 'verify preview database' --non-interactive",
          "description": "Smoke test preview database",
          "dependencies": ["migrate-preview"],
          "timeout": 180
        }
      ]
    },
    {
      "name": "deploy-production",
      "parallel": false,
      "steps": [
        {
          "id": "migrate-production",
          "agent": "devops",
          "command": "pnpm db:migrate:prod",
          "description": "Deploy to production database",
          "dependencies": ["smoke-test-preview"],
          "timeout": 300
        },
        {
          "id": "verify-production",
          "agent": "monitor",
          "command": "npx claude-flow monitor --duration 300",
          "description": "Monitor production database",
          "dependencies": ["migrate-production"],
          "timeout": 300
        }
      ]
    }
  ],
  "rollback": {
    "automatic": true,
    "backup-id": "latest",
    "conditions": [
      {
        "type": "migration-failure",
        "action": "restore-backup"
      }
    ]
  }
}
